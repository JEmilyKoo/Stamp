<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<!-- namespace속성:매퍼파일의 완전한경로 .xml는 생략 -->
<!-- ※ibatis와는 다르게 id값에 .(dot)를 사용 못한다. -->
<mapper namespace="mybatis.mapper.dm">
	
	<resultMap 
		type="com.company.exer.service.DMDTO"
		id="DMDTOResult">

		<result column="dmno" property="dMNo" />
		<result column="nickname" property="nickname" />
		<result column="dmtonickname" property="dMToNickname" />
		<result column="dmctt" property="dMCtt" />
		<result column="dmdate" property="dMDate" />
		<result column="dmchecked" property="dMChecked" />
	</resultMap>
	<!--  회원가입 및 로그인 시작 -->
	<!-- 회원가입 확인용 -->
	
	
	
	

	<!-- DM기능 구현용 시작-->

	<!-- 1. DM 테이블 INSERT -->
	<insert id="sendDM"
		parameterType="com.company.exer.service.DMDTO">
		
		INSERT INTO DM VALUES(
		SEQ_DM.NEXTVAL,
		#{nickname},
		#{dMCtt},
		#{dMToNickname},
		default,
		default,
		default)
	</insert>
	
	<!-- 2. DM 전체 메세지함 쿼리문 -->
	<select id="dMList" parameterType="Map"
		resultType="com.company.exer.service.DMDTO">
		
		SELECT nickname,dMToNickname,max(dMDate) dMDate FROM dm
		WHERE nickname = #{nickname} OR dMToNickname = #{nickname}
		GROUP BY nickname, dMToNickname
	</select>
	
	<!-- 3. 최신 발신내역 가져오는 쿼리문 -->
	<select id="getDMSendList" parameterType="Map"
		resultMap="DMDTOResult">
		
		SELECT *
		FROM (SELECT * FROM dm ORDER BY ROWNUM DESC)
		WHERE (nickname,dMToNickname) IN
		((#{nickname},#{dMToNickname}),(#{dMToNickname},#{nickname})) 
		AND ROWNUM = 1
	</select> 
	
	<!-- 4. DM 1:1대화목록 쿼리문 -->
	<select id="DMChatList" parameterType="Map"
		resultType="com.company.exer.service.DMDTO">
		
		SELECT *
		FROM dm 
		WHERE (nickname,dMToNickname) IN
		((#{nickname},#{dMToNickname}),(#{dMToNickname},#{nickname}))
	</select>
	
	<!-- 5. 읽음 처리 쿼리문 -->
	<update id="checkDM" parameterType="com.company.exer.service.DMDTO" >
	
		UPDATE dm 
		SET dMChecked = ' '
		WHERE nickname= #{nickname} AND  dMToNickname = #{dMToNickname}
	</update>
	<select id="cntNewDM"
		parameterType="com.company.exer.service.DMDTO" resultType="int">
		
		SELECT COUNT(dMChecked) 
		FROM DM 
		WHERE nickname= #{nickname} AND  dMToNickname = #{dMToNickname}
		AND dMChecked='1'
	</select>
</mapper>